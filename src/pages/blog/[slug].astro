---
import { getCollection, type CollectionEntry } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import CTASection from '../../components/sections/CTASection.astro';

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

interface Props {
  post: CollectionEntry<'posts'>;
}

const { post } = Astro.props;
const { Content } = await post.render();

const { title, date, excerpt, category, tags, coverImage, seo } = post.data;

// Calculate reading time
const content = post.body || '';
const wordsPerMinute = 200;
const wordCount = content.split(/\s+/).length;
const readingTime = Math.max(1, Math.ceil(wordCount / wordsPerMinute));

// Get related posts (same category, exclude current)
const allPosts = await getCollection('posts');
const relatedPosts = allPosts
  .filter(p => p.slug !== post.slug && p.data.category === category)
  .slice(0, 3);

// Get services for the sidebar
const allServices = await getCollection('services');

// Helper function to get service URL based on pillar
const getServiceUrl = (serviceSlug: string, pillar?: string) => {
  const pillars: Record<string, string> = {
    'repairs': '/repairs/',
    'remodeling': '/remodeling/',
    'emergency-services': '/emergency-services/'
  };
  const basePath = pillar ? pillars[pillar] || '/services/' : '/services/';
  return `${basePath}${serviceSlug}`;
};

// Get highlighted services (mix from each pillar)
const repairServices = allServices.filter(s => s.data.pillar === 'repairs').slice(0, 3);
const remodelingServices = allServices.filter(s => s.data.pillar === 'remodeling').slice(0, 2);
const featuredServices = [...repairServices, ...remodelingServices];

// Use cover image from post data, fallback to default
const postImage = coverImage
  ? `https://www.ifixxnc.com${coverImage}`
  : "https://www.ifixxnc.com/images/ui/hero-bg.jpg";

// BlogPosting schema (enhanced for SEO)
const blogPostSchema = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": `https://www.ifixxnc.com/blog/${post.slug}`
  },
  "headline": title,
  "description": excerpt,
  "image": {
    "@type": "ImageObject",
    "url": postImage,
    "width": 1200,
    "height": 630
  },
  "url": `https://www.ifixxnc.com/blog/${post.slug}`,
  "datePublished": date.toISOString(),
  "dateModified": date.toISOString(),
  "author": {
    "@type": "Organization",
    "@id": "https://www.ifixxnc.com/#business",
    "name": "iFixx Remodeling & Handyman Services",
    "url": "https://www.ifixxnc.com"
  },
  "publisher": {
    "@type": "Organization",
    "@id": "https://www.ifixxnc.com/#business",
    "name": "iFixx Remodeling & Handyman Services",
    "url": "https://www.ifixxnc.com",
    "logo": {
      "@type": "ImageObject",
      "url": "https://www.ifixxnc.com/images/logo.svg",
      "width": 200,
      "height": 60
    }
  },
  "articleSection": category,
  "keywords": tags ? tags.join(", ") : ""
};

// Breadcrumb schema
const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": "https://www.ifixxnc.com"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Blog",
      "item": "https://www.ifixxnc.com/blog"
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": title,
      "item": `https://www.ifixxnc.com/blog/${post.slug}`
    }
  ]
};
---

<BaseLayout 
  title={seo.title}
  description={seo.description}
  canonical={`/blog/${post.slug}`}
>
  <Fragment slot="schema">
    <script type="application/ld+json" set:html={JSON.stringify(blogPostSchema)} />
    <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />
  </Fragment>

  <article>
    <!-- Hero Section -->
    <section class="bg-gradient-to-br from-neutral-50 to-white py-16 lg:py-20">
      <div class="container">
        <div class="max-w-4xl mx-auto">
          <!-- Breadcrumb -->
          <nav class="mb-6">
            <ol class="flex items-center gap-2 text-sm text-neutral-500">
              <li><a href="/" class="hover:text-primary-600">Home</a></li>
              <li>/</li>
              <li><a href="/blog" class="hover:text-primary-600">Blog</a></li>
              <li>/</li>
              <li class="text-neutral-900 font-medium truncate">{title}</li>
            </ol>
          </nav>

          <!-- Category -->
          <span class="inline-block px-3 py-1 bg-primary-100 text-primary-700 text-sm font-medium rounded-full mb-4">
            {category}
          </span>

          <!-- Title -->
          <h1 class="text-4xl lg:text-5xl xl:text-6xl font-heading font-bold text-neutral-900 mb-6 leading-tight">
            {title}
          </h1>

          <!-- Meta -->
          <div class="flex items-center gap-4 text-neutral-500">
            <time datetime={date.toISOString()}>
              {date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}
            </time>
            <span>â€¢</span>
            <span>{readingTime} min read</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Cover Image -->
    <section class="container mb-12">
      <div class="max-w-4xl mx-auto aspect-[21/9] rounded-2xl overflow-hidden">
        {coverImage ? (
          <img
            src={coverImage}
            alt={title}
            class="w-full h-full object-cover"
            loading="eager"
            decoding="async"
          />
        ) : (
          <div class="w-full h-full bg-gradient-to-br from-primary-100 via-secondary-100 to-primary-200 flex items-center justify-center">
            <svg class="w-20 h-20 text-white/50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
          </div>
        )}
      </div>
    </section>

    <!-- Content -->
    <section class="container">
      <div class="max-w-4xl mx-auto">
        <div class="prose prose-lg lg:prose-xl prose-neutral max-w-none prose-headings:font-heading prose-headings:font-bold prose-a:text-primary-600 prose-a:no-underline hover:prose-a:underline prose-h2:border-b prose-h2:border-neutral-200 prose-h2:pb-3 prose-headings:mt-12 prose-headings:mb-4 prose-p:leading-relaxed">
          <Content />
        </div>

        <!-- Tags -->
        {tags && tags.length > 0 && (
          <div class="mt-12 pt-8 border-t border-neutral-200">
            <div class="flex flex-wrap items-center gap-2">
              <span class="text-sm font-medium text-neutral-700">Tags:</span>
              {tags.map((tag) => (
                <span class="px-3 py-1 bg-neutral-100 text-neutral-600 text-sm rounded-full">
                  {tag}
                </span>
              ))}
            </div>
          </div>
        )}

        <!-- Inline CTA -->
        <div class="mt-12 p-8 bg-gradient-to-r from-primary-600 to-primary-700 rounded-2xl shadow-lg">
          <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
            <div>
              <h3 class="text-xl lg:text-2xl font-heading font-bold text-white mb-2">
                Need Help With Your Home?
              </h3>
              <p class="text-primary-100">
                Our team of experts is ready to help with any repair or remodeling project.
              </p>
            </div>
            <div class="flex flex-col sm:flex-row gap-3 lg:flex-shrink-0">
              <a href="/contact" class="btn bg-white text-primary-700 hover:bg-primary-50 font-semibold px-6 py-3">
                Request Free Estimate
              </a>
              <a href="tel:+19803916833" class="btn border-2 border-white text-white hover:bg-white/10 font-semibold px-6 py-3">
                Call (980) 391-6833
              </a>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Related Posts -->
    {relatedPosts.length > 0 && (
      <section class="section section-alt mt-12">
        <div class="container">
          <h2 class="text-2xl font-heading font-bold text-neutral-900 mb-8 text-center">
            Related Articles
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-5xl mx-auto">
            {relatedPosts.map((relatedPost) => (
              <a href={`/blog/${relatedPost.slug}`} class="card p-4 group">
                <div class="aspect-[16/10] bg-gradient-to-br from-primary-100 to-secondary-100 rounded-lg mb-4"></div>
                <h3 class="font-semibold text-neutral-900 group-hover:text-primary-600 transition-colors">
                  {relatedPost.data.title}
                </h3>
              </a>
            ))}
          </div>
        </div>
      </section>
    )}

    <!-- Related Services -->
    <section class="section">
      <div class="container">
        <div class="max-w-5xl mx-auto">
          <h2 class="text-2xl font-heading font-bold text-neutral-900 mb-4 text-center">
            Our Services
          </h2>
          <p class="text-neutral-600 text-center mb-8 max-w-2xl mx-auto">
            Need help with a project? We offer expert repair and remodeling services throughout Charlotte.
          </p>

          <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
            {featuredServices.map((service) => (
              <a
                href={getServiceUrl(service.slug, service.data.pillar)}
                class="group p-4 bg-neutral-50 rounded-xl border border-neutral-200 hover:border-primary-300 hover:bg-primary-50 transition-all text-center"
              >
                <h3 class="font-medium text-neutral-900 group-hover:text-primary-600 transition-colors text-sm">
                  {service.data.title}
                </h3>
              </a>
            ))}
          </div>

          <div class="flex flex-wrap items-center justify-center gap-4 mt-8">
            <a href="/repairs" class="inline-flex items-center text-primary-600 hover:text-primary-700 font-medium text-sm">
              All Repair Services
              <svg class="w-4 h-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </a>
            <a href="/remodeling" class="inline-flex items-center text-primary-600 hover:text-primary-700 font-medium text-sm">
              All Remodeling Services
              <svg class="w-4 h-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </a>
            <a href="/emergency-services" class="inline-flex items-center text-primary-600 hover:text-primary-700 font-medium text-sm">
              Emergency Services
              <svg class="w-4 h-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </a>
          </div>
        </div>
      </div>
    </section>
  </article>

  <!-- Final CTA -->
  <CTASection />
</BaseLayout>
