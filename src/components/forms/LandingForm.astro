---
interface Props {
  formId: string;
  formName: string;
  servicePreselect?: string;
  ctaText?: string;
}

const { formId, formName, servicePreselect = '', ctaText = 'Get Free Estimate Now' } = Astro.props;

const services = [
  { value: 'emergency-repair', label: 'Emergency Repair' },
  { value: 'water-damage', label: 'Water Damage' },
  { value: 'faucet-fixture', label: 'Faucet & Fixture Repair' },
  { value: 'door-window', label: 'Door & Window Repair' },
  { value: 'drywall', label: 'Drywall Repair' },
  { value: 'painting', label: 'Painting' },
  { value: 'electrical-fixture', label: 'Outlet & Light Fixtures' },
  { value: 'ceiling-fan', label: 'Ceiling Fan Installation' },
  { value: 'tv-mounting', label: 'TV Mounting' },
  { value: 'carpentry', label: 'Carpentry' },
  { value: 'pressure-washing', label: 'Pressure Washing' },
  { value: 'other', label: 'Other' }
];
---

<div class="bg-white rounded-2xl shadow-2xl p-6 lg:p-8 border border-neutral-200">
  <div class="text-center mb-5">
    <h3 class="text-xl font-heading font-bold text-neutral-900 mb-1">Get Your Free Estimate</h3>
    <p class="text-sm text-neutral-600">No obligation. We respond fast.</p>
  </div>

  <form id={formId} class="space-y-3">
    <input type="text" name="firstName" required
      class="w-full px-4 py-3 rounded-lg border border-neutral-300 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-neutral-900 placeholder-neutral-500"
      placeholder="Your Name *" />

    <input type="tel" name="phone" required
      class="w-full px-4 py-3 rounded-lg border border-neutral-300 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-neutral-900 placeholder-neutral-500"
      placeholder="Phone Number *" />

    <input type="email" name="email" required
      class="w-full px-4 py-3 rounded-lg border border-neutral-300 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-neutral-900 placeholder-neutral-500"
      placeholder="Email Address *" />

    <select name="service" required
      class="w-full px-4 py-3 rounded-lg border border-neutral-300 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-neutral-900">
      <option value="">What do you need help with? *</option>
      {services.map((s) => (
        <option value={s.value} selected={servicePreselect === s.value}>{s.label}</option>
      ))}
    </select>

    <textarea name="message" rows="2"
      class="w-full px-4 py-3 rounded-lg border border-neutral-300 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-neutral-900 placeholder-neutral-500 resize-none"
      placeholder="Briefly describe the issue (optional)"></textarea>

    <button type="submit" class="w-full btn btn-emergency text-lg py-4 justify-center font-bold">
      <span class="btn-text">{ctaText}</span>
      <svg class="btn-spinner hidden w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
    </button>

    <p class="text-xs text-center text-neutral-500">Your information is secure and never shared.</p>
  </form>

  <div class="form-success hidden mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
    <div class="flex items-center gap-3">
      <svg class="w-5 h-5 text-green-600 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
      </svg>
      <div>
        <p class="font-semibold text-green-800 text-sm">Thank you!</p>
        <p class="text-green-700 text-xs">We'll contact you shortly.</p>
      </div>
    </div>
  </div>

  <div class="form-error hidden mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
    <p class="font-semibold text-red-800 text-sm">Something went wrong. Please call us directly.</p>
  </div>
</div>

<script define:vars={{ formId, formName }}>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById(formId);
    if (!form) return;

    const btnText = form.querySelector('.btn-text');
    const btnSpinner = form.querySelector('.btn-spinner');
    const successMsg = form.parentElement?.querySelector('.form-success');
    const errorMsg = form.parentElement?.querySelector('.form-error');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      successMsg?.classList.add('hidden');
      errorMsg?.classList.add('hidden');
      btnText?.classList.add('hidden');
      btnSpinner?.classList.remove('hidden');

      const formData = new FormData(form);
      const data = {
        firstName: formData.get('firstName'),
        lastName: '',
        email: formData.get('email'),
        phone: formData.get('phone'),
        service: formData.get('service'),
        message: formData.get('message') || '',
        source: formName,
        utm_source: sessionStorage.getItem('utm_source') || '',
        utm_medium: sessionStorage.getItem('utm_medium') || '',
        utm_campaign: sessionStorage.getItem('utm_campaign') || '',
        utm_term: sessionStorage.getItem('utm_term') || '',
        gclid: sessionStorage.getItem('gclid') || ''
      };

      try {
        const response = await fetch('/api/lead', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const result = await response.json();

        if (result.success) {
          // Push dataLayer event before redirect
          window.dataLayer = window.dataLayer || [];
          window.dataLayer.push({
            'event': 'generate_lead',
            'form_id': formId,
            'form_name': formName,
            'form_location': window.location.pathname,
            'lead_type': 'google_ads',
            'utm_source': data.utm_source,
            'utm_medium': data.utm_medium,
            'utm_campaign': data.utm_campaign
          });
          // Redirect to thank you page
          window.location.href = '/lp/thank-you';
        } else {
          throw new Error(result.error || 'Unknown error');
        }
      } catch (error) {
        errorMsg?.classList.remove('hidden');
      } finally {
        btnText?.classList.remove('hidden');
        btnSpinner?.classList.add('hidden');
      }
    });
  });
</script>
