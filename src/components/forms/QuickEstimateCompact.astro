---
interface Props {
  serviceSlug?: string;
  serviceTitle?: string;
  formId?: string;
}

const { serviceSlug = '', serviceTitle = '', formId = 'quick-estimate-form' } = Astro.props;

const services = [
  { value: 'plumbing', label: 'Plumbing' },
  { value: 'electrical', label: 'Electrical' },
  { value: 'carpentry', label: 'Carpentry' },
  { value: 'painting', label: 'Painting' },
  { value: 'doors-windows', label: 'Doors & Windows' },
  { value: 'quick-fix', label: 'Quick Fix Services' },
  { value: 'bathroom-remodel', label: 'Bathroom Remodel' },
  { value: 'kitchen-remodel', label: 'Kitchen Remodel' },
  { value: 'emergency-plumbing', label: 'Emergency Plumbing' },
  { value: 'other', label: 'Other' }
];
---

<div class="bg-white rounded-2xl shadow-xl p-6 lg:p-8">
  <!-- Header -->
  <div class="text-center mb-6">
    <h3 class="text-xl lg:text-2xl font-heading font-bold text-neutral-900 mb-2">
      Get Your Free Estimate
    </h3>
    <p class="text-sm text-neutral-600">
      No obligation. Response within 24 hours.
    </p>
  </div>

  <!-- Form -->
  <form id={formId} class="space-y-4">
    <!-- Name -->
    <div>
      <label for={`${formId}-name`} class="sr-only">Your Name</label>
      <input
        type="text"
        id={`${formId}-name`}
        name="firstName"
        required
        class="w-full px-4 py-4 rounded-lg border border-neutral-300 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors text-neutral-900 placeholder-neutral-500"
        placeholder="Your Name *"
      />
    </div>

    <!-- Phone -->
    <div>
      <label for={`${formId}-phone`} class="sr-only">Phone Number</label>
      <input
        type="tel"
        id={`${formId}-phone`}
        name="phone"
        required
        class="w-full px-4 py-4 rounded-lg border border-neutral-300 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors text-neutral-900 placeholder-neutral-500"
        placeholder="Phone Number *"
      />
    </div>

    <!-- Email -->
    <div>
      <label for={`${formId}-email`} class="sr-only">Email Address</label>
      <input
        type="email"
        id={`${formId}-email`}
        name="email"
        required
        class="w-full px-4 py-4 rounded-lg border border-neutral-300 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors text-neutral-900 placeholder-neutral-500"
        placeholder="Email Address *"
      />
    </div>

    <!-- Service Selector (always visible, pre-selected if on service page) -->
    <div>
      <label for={`${formId}-service`} class="sr-only">Service Needed</label>
      <select
        id={`${formId}-service`}
        name="service"
        required
        class="w-full px-4 py-4 rounded-lg border border-neutral-300 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors text-neutral-900"
      >
        <option value="">Select a service... *</option>
        {services.map((s) => (
          <option value={s.value} selected={serviceSlug === s.value}>{s.label}</option>
        ))}
      </select>
    </div>

    <!-- Project Description -->
    <div>
      <label for={`${formId}-message`} class="sr-only">Project Description</label>
      <textarea
        id={`${formId}-message`}
        name="message"
        rows="3"
        class="w-full px-4 py-4 rounded-lg border border-neutral-300 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors text-neutral-900 placeholder-neutral-500 resize-none"
        placeholder="Describe your project (optional)..."
      ></textarea>
    </div>

    <!-- Submit Button -->
    <button
      type="submit"
      class="w-full btn btn-primary text-lg py-4 justify-center font-bold"
    >
      <span class="btn-text">Get Free Estimate</span>
      <svg class="btn-spinner hidden w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
    </button>

    <!-- Trust Text -->
    <p class="text-xs text-center text-neutral-500">
      Your information is secure and will never be shared.
    </p>
  </form>

  <!-- Success Message -->
  <div class="form-success hidden mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
    <div class="flex items-center gap-3">
      <svg class="w-5 h-5 text-green-600 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
      </svg>
      <div>
        <p class="font-semibold text-green-800 text-sm">Thank you!</p>
        <p class="text-green-700 text-xs">We'll contact you within 24 hours.</p>
      </div>
    </div>
  </div>

  <!-- Error Message -->
  <div class="form-error hidden mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
    <div class="flex items-center gap-3">
      <svg class="w-5 h-5 text-red-600 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
      <p class="font-semibold text-red-800 text-sm">Something went wrong. Please try again.</p>
    </div>
  </div>
</div>

<script define:vars={{ formId }}>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById(formId);
    if (!form) return;

    const btnText = form.querySelector('.btn-text');
    const btnSpinner = form.querySelector('.btn-spinner');
    const successMsg = form.parentElement?.querySelector('.form-success');
    const errorMsg = form.parentElement?.querySelector('.form-error');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Reset states
      successMsg?.classList.add('hidden');
      errorMsg?.classList.add('hidden');
      btnText?.classList.add('hidden');
      btnSpinner?.classList.remove('hidden');

      const formData = new FormData(form);
      const data = {
        firstName: formData.get('firstName'),
        lastName: '',
        email: formData.get('email'),
        phone: formData.get('phone'),
        service: formData.get('service'),
        message: formData.get('message') || '',
        source: 'Quick Estimate Form'
      };

      try {
        const response = await fetch('/api/lead', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
          // Track form submission in GTM before redirect
          window.dataLayer = window.dataLayer || [];
          window.dataLayer.push({
            'event': 'form_submit',
            'form_id': formId,
            'form_name': 'Quick Estimate Form',
            'form_location': window.location.pathname,
            'lead_type': 'quick_estimate'
          });
          
          // Redirect to thank you page
          window.location.href = '/lp/thank-you';
        } else {
          throw new Error(result.error || 'Unknown error');
        }
      } catch (error) {
        errorMsg?.classList.remove('hidden');
      } finally {
        btnText?.classList.remove('hidden');
        btnSpinner?.classList.add('hidden');
      }
    });
  });
</script>
